# ALFAM2 confidence interval based on parameter uncertainty

```{r}
library(ALFAM2)
packageVersion('ALFAM2')
```

```{r}
#remove.packages('ALFAM2') ; devtools::install_github('sashahafner/ALFAM2', ref = 'dev')
```


```{r}
dat <- data.frame(ctime = 0:84*2, TAN.app = 100, man.dm = 8, 
                  air.temp = 7 + 7*sin(0:84*2 * 2*pi/24) + rnorm(85, 0, 2), 
                  wind = 10^(0.5 + 0.4*sin(0:84*2 * 2*pi/24) + 
                             rnorm(85, 0, 0.12)), 
                  app.mthd = "bc")
```

```{r}
#plot(air.temp ~ ctime, data = dat, type = 'o', col = 'gray45')
#plot(wind ~ ctime, data = dat, type = 'o', col = 'blue')
```

Normal call without confidence intervals (CI).

```{r}
pred1 <- alfam2(dat, app.name = 'TAN.app', time.name = 'ctime', warn = FALSE)
head(pred1)
```

# CI with defaults

Add CI.

```{r}
predci <- alfam2(dat, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', warn = FALSE, conf.int = 0.90, 
                pars.ci = alfam2pars03var_alpha)
head(predci)
```

By default only returned for variable `er` = relative cumulative emission.

```{r}
plot(er ~ ctime, data = predci, type = 'l', ylim = c(0, max(predci$er.upr)))
lines(er.lwr ~ ctime, data = predci, type = 'l', col = 'blue')
lines(er.upr ~ ctime, data = predci, type = 'l', col = 'red')
```

# Add variables

Can add any variables for CI calculation, but `quantile` is applied by variable.

```{r}
predci <- alfam2(dat, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', warn = FALSE, conf.int = 0.90, 
                pars.ci = alfam2pars03var_alpha, var.ci = c('er', 'j', 'r1'))
head(predci)
```

Note that times with any `NaN` etc. in one of `var.ci` columns will be dropped.
So here flux `j` is undefined for first time interval (0 - 0 h).

```{r}
plot(er ~ ctime, data = predci, type = 'l', ylim = c(0, max(predci$er.upr)))
lines(er.lwr ~ ctime, data = predci, type = 'l', col = 'blue')
lines(er.upr ~ ctime, data = predci, type = 'l', col = 'red')
```

```{r}
plot(j ~ ctime, data = predci, type = 's', ylim = c(0, max(predci$j.upr)))
lines(j.lwr ~ ctime, data = predci, type = 's', col = 'blue')
lines(j.upr ~ ctime, data = predci, type = 's', col = 'red')
```

# Test on multiple groups

Here is a test where each group has a different incorporation time

```{r}
datm <- data.frame(scenario = 1:6, ctime = 168, TAN.app = 50, 
                   man.dm = 8, air.temp = 20, wind.2m = 4, 
                   app.mthd = 'bc',
                   incorp = 'deep', 
                   t.incorp = c(0.1, 1, 6, 24, 168, NA))
```


```{r}
predci <- alfam2(datm, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', time.incorp = 't.incorp', group = 'scenario',
                conf.int = 0.90, 
                pars.ci = alfam2pars03var_alpha, var.ci = c('er'))
predci
```

Plot emission versus time of incorporation.

```{r}
plot(datm$t.incorp, predci$er, type = 'o', ylim = c(0, max(predci$er.upr)))
lines(datm$t.incorp, predci$er.lwr, type = 'o', col = 'blue')
lines(datm$t.incorp, predci$er.upr, type = 'o', col = 'red')
```

# Limit number of iterations

By default the model is run with all the different parameter sets provided in `pars.ci`.

```{r}
dim(alfam2pars03var_alpha)
```

For speed some users might want to sometimes reduce that.

```{r}
predci <- alfam2(datm, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', time.incorp = 't.incorp', group = 'scenario',
                conf.int = 0.90, pars.ci = alfam2pars03var_alpha,
                n.ci = 10)
predci
```

# Get all predictions
When `ci=` some number it is used in the `quantile` function.
To get all results, use `conf.int = 'all'`.
This could be useful to combine uncertainty in parameter values with uncertainty in inputs.
Of course then the CIs would have to be constructed outside the `alfam2` function, but it cannot do everything, so I think this is OK.

```{r}
datvar <- data.frame(ctime = 168, TAN.app = 50, man.dm = rnorm(7, mean = 8, sd = 1), air.temp = 20, wind.2m = 3)
```

Here is what we get with numeric `conf.int`.

```{r}
predci <- alfam2(datvar, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', group = 'man.dm',
                conf.int = 0.90, pars.ci = alfam2pars03var_alpha)
predci
```

Not so useful.

The alternative:


```{r}
predci <- alfam2(datvar, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', group = 'man.dm',
                conf.int = 'all', pars.ci = alfam2pars03var_alpha, n.ci = 3)
predci
```

21 rows here, small so we can look at the results.

More plausible usage would have at least 100 of each I suppose, for 10000 rows in the output.

```{r}
datvar <- data.frame(ctime = 168, TAN.app = 50, man.dm = rnorm(100, mean = 8, sd = 1), air.temp = 20, wind.2m = 3)
```

```{r}
predci <- alfam2(datvar, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', group = 'man.dm',
                conf.int = 'all', pars.ci = alfam2pars03var_alpha, n.ci = 100)
head(predci)
```

And then, externally, for a 95% confidence interval that includes uncertainty in both inputs (only DM here) and parameters:

```{r}
quantile(predci$er, c(0.05, 0.95))
```

# Error messages

```{r,error=TRUE}
predci <- alfam2(datvar, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', group = 'man.dm',
                conf.int = 'all', n.ci = 100)
```

```{r,error=TRUE}
predci <- alfam2(datvar, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', group = 'man.dm',
                conf.int = 'all', pars.ci = alfam2pars03var_alpha, n.ci = 1000)
```

```{r,error=TRUE}
predci <- alfam2(datvar, pars = alfam2pars03_alpha, app.name = 'TAN.app', 
                time.name = 'ctime', group = 'man.dm',
                conf.int = 'all', pars.ci = alfam2pars03var_alpha, n.ci = 10, 
                var.ci = 'blahblah')
```


